<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org">

  <head>
    <title>宁波本源智能科技有限公司</title>
    <meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" type="text/css" media="all" th:href=@{css/scan.css}>
    <script type="text/javascript" th:src=@{js/jquery.min.js}></script>
    <script type="text/javascript" src="js/jweixin-1.3.2.js"></script>
    <script type="text/javascript" th:inline="javascript">
      var ctx;
      var files;
      function dataURLtoFile(dataurl, filename){
          var arr = dataurl.split(',');
          var mime = arr[0].match(/:(.*?);/)[1];
          var bstr = atob(arr[1]);
          var n = bstr.length;
          var u8arr = new Uint8Array(n);
          while (n--) {
            u8arr[n] = bstr.charCodeAt(n);
          }
          return new File([u8arr], filename, { type: mime });
      }
      function create(canvas){
    	  $(canvas).get(0).height=$('.center').height()+10;
    	  $(canvas).get(0).width=$('.center').height()+10;
    	  ctx = $(canvas).get(0).getContext('2d');
      }
      function draw(degree){
    	  var r = $('.center').height();
    	  degree = degree/50;
    	  ctx.clearRect(0,0,r+10,r+10);
    	  ctx.beginPath();
    	  ctx.lineWidth = 6;
    	  var gradient=ctx.createLinearGradient(0,0,360,0);
    	  gradient.addColorStop("0","magenta");
    	  gradient.addColorStop("0.3","yellow");
    	  gradient.addColorStop("0.7","green");
    	  gradient.addColorStop("1.0","yellow");
    	  ctx.strokeStyle = gradient;
    	  ctx.arc(r/2+2,r/2+2,r/2,0-Math.PI*0.5,Math.PI*degree-Math.PI*0.5,false);
    	  ctx.stroke();
      }
      $(document).ready(function(){
    	  create('.progress');
    	  
          $("#camera").click(function(){
              $("#file").click();
          });
    	  $("#file").change(function(){
    		  var filename = this.files[0].name;
    		  url = window.URL.createObjectURL(this.files[0])
    		  $("#camera").attr('src',url);
    		  var nimg = new Image();
    		  nimg.src = url;
 		      nimg.onload = function(){
                  var canvas = document.querySelector('#canvas');
	              var context = canvas.getContext('2d');
 		    	  if (nimg.height > nimg.width){
 		    		  canvas.width = 720;
 		    		  canvas.height = 960;
 		    		  context.drawImage(nimg,0,0, 720, 960);
 		    	  } else {
 		    		 canvas.width = 960;
                     canvas.height = 720;
 		    		 context.drawImage(nimg,0,0, 960, 720);
 		    	  }
 		    	  var dataURL = canvas.toDataURL('image/jpeg',1.0);
 		    	  var file = dataURLtoFile(dataURL, filename);
 	              var formData = new FormData();
 	              formData.append('file',file); 
    			  
    			  var prog = 0;
                  var inter = setInterval(function(){
                      if (prog>=100){
                          clearInterval(inter);
                      }
                      prog = prog+0.25;
                      draw(prog);
                  },60);
                  $.post({url: "/upload",
                          data: formData,
                          contentType: false,
                          processData: false,
                          error: function(res){
                              clearInterval(inter);
                              draw(0);
                              $(".info").text(res);
                              setTimeout(function(){
                                  wx.miniProgram.redirectTo({
                                      url: '/pages/fail/fail'
                                  });
                              },1000);
                          },
                          success: function(res){
                               var resObj = JSON.parse(res);
                               if (resObj.notexist){
                                   clearInterval(inter);
                                   draw(0);
                                   $(".info").text('溯源信息不存在');
                                   setTimeout(function(){
                                       wx.miniProgram.redirectTo({
                                           url: '/pages/fail/fail'
                                       });
                                   },1000);
                               } else if (resObj.picinvalid){
                                   clearInterval(inter);
                                   draw(0);
                                   $(".info").text('照片不含防伪信息');
                                   setTimeout(function(){
                                       wx.miniProgram.redirectTo({
                                           url: '/pages/fail/fail'
                                       });
                                   },1000);
                               } else if (resObj.code == 0){
                                   clearInterval(inter);
                                   draw(100);
                                   $(".info").text('检测成功，跳转中');
                                   setTimeout(function(){
                                       wx.miniProgram.redirectTo({
                                           url: '/pages/success/success?id='+resObj.id
                                                   +"&successcontent="+resObj.successcontent
                                                   +"&bottomtime="+resObj.bottomtime
                                                   +"&bottomcount="+resObj.bottomcount
                                       });
                                   },1000);
                               }
                          }
                  });
    		  };
    		  
          });
      });
    </script>
  </head>

  <body class="bg">
    <div class="content">
        <div class="up">
          <image src="/img/logo.png" class="logo"></image>
          <image src="/img/title.png" class="title"></image>
        </div>
        <div class="down">
            <input type='file' hidden="true" id="file" accept="image/*"></input>
            <text class="desc">请用您的手机给产品的图像拍照</text>
            <div class="center">
                <canvas class="progress"></canvas>
                <image src="img/camera.png" class="camera" id="camera"></image>
            </div>
            <text class="info"></text>
        </div>
    </div>
    <canvas id="canvas" hidden="true"></canvas>
  </body>
</html>